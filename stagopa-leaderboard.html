<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stagopa Leaderboard</title>
<style>
  html, body { height:100%; margin:0; overflow:hidden; }
  body{
    background:#05060a;
    color:#e9eefc;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center;
  }
  .wrap{
    width:min(900px,96vw);
    height:92vh;
    overflow:auto;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px;
    padding:16px;
    box-shadow:0 14px 30px rgba(0,0,0,0.45);
  }
  .brand{
    display:flex; gap:10px; justify-content:center; align-items:center;
    margin-bottom:10px;
  }
  .brand img{
    width:56px; height:56px; border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:#000;
    object-fit:cover;
  }
  h1{
    margin:6px 0 2px;
    text-align:center;
    font-size:18px;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  .sub{
    text-align:center;
    font-size:13px;
    opacity:0.8;
    margin-bottom:12px;
  }

  .bar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin:10px 0 14px;
  }
  .pill{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    font-weight:800;
    font-size:12px;
    opacity:0.95;
  }
  .btn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    color:#e9eefc;
    font-weight:900;
    cursor:pointer;
  }
  .btn.primary{
    border:0;
    background:linear-gradient(135deg,#ff3cac,#784ba0,#2b86c5);
    color:white;
  }

  /* Collapsible panel (Glide-safe) */
  .panel{
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.18);
    padding:12px;
    margin: 0 0 12px;
  }
  .panelHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .panelTitle{
    font-weight:900;
    letter-spacing:0.06em;
    text-transform:uppercase;
    font-size:13px;
  }
  .toggleBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    color:#e9eefc;
    font-weight:900;
    cursor:pointer;
    display:flex; align-items:center; gap:10px;
  }
  .chev{
    width:28px; height:28px;
    display:grid; place-items:center;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    font-weight:900;
    opacity:0.9;
    transform: rotate(0deg);
    transition: transform .15s ease;
  }
  .panelBody{
    margin-top:10px;
    border-top:1px solid rgba(255,255,255,0.10);
    padding-top:10px;
    display:none; /* collapsed by default */
  }
  .panelBody.open{ display:block; }
  .chev.open{ transform: rotate(90deg); }

  .rules{
    font-size:13px;
    line-height:1.4;
    opacity:0.9;
    margin:0 0 10px;
  }
  .rules ul{ margin:8px 0 0 18px; padding:0; }
  .rules li{ margin:4px 0; }

  /* New: button row inside the panel */
  .panelActions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:12px;
  }
  a.btnLink{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .hint{
    font-size:12px;
    opacity:0.75;
    margin-top:8px;
  }

  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  @media (min-width: 860px){
    .grid{ grid-template-columns:1fr 1fr; }
  }
  .card{
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.18);
    padding:12px;
  }
  .card h2{
    margin:0 0 10px;
    font-size:14px;
    letter-spacing:0.06em;
    text-transform:uppercase;
    opacity:0.95;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th, td{
    padding:8px 8px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    text-align:left;
    vertical-align:middle;
  }
  th{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.06em;
    opacity:0.8;
  }
  .rank{
    width:44px;
    text-align:center;
    font-weight:900;
    opacity:0.9;
  }
  .pts{
    text-align:right;
    font-weight:900;
  }
  .topRow td{
    background:rgba(255,255,255,0.06);
  }
  .muted{ opacity:0.75; }
  .error{
    padding:12px;
    border-radius:14px;
    border:1px dashed rgba(255,255,255,0.2);
    background:rgba(0,0,0,0.25);
    font-weight:800;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <img src="stagopa-logo.png" alt="Stagopa">
    <img src="dctrigon-logo.png" alt="DC Trigon">
  </div>

  <h1>Stagopa League Leaderboard</h1>
  <div class="sub">Live points table. One drink = one log. No mercy.</div>

  <!-- Collapsible: How to play + Link button (Glide-safe) -->
  <div class="panel" id="logPanel">
    <div class="panelHeader">
      <div class="panelTitle">Log a Drink + How it Works</div>
      <button class="toggleBtn" id="toggleLog" type="button">
        <span id="toggleText">Open</span>
        <span class="chev" id="toggleChev">‚Ä∫</span>
      </button>
    </div>

    <div class="panelBody" id="panelBody">
      <div class="rules">
        <b>How it‚Äôs played:</b>
        <ul>
          <li>Every time you finish a drink, submit <b>one log</b>.</li>
          <li>Pick the correct <b>Segment</b> (Day 1 before 17:00 / Day 1 Part 2 / Day 2 / Day 3 / Day 4).</li>
          <li>Points are added automatically ‚Äî hit <b>Refresh</b> if you want instant bragging rights.</li>
          <li><b>Core squad only</b> from Day 1 Part 2 onwards (Ben / Brad / Craig).</li>
          <li>Alex logs <b>soft drinks</b> on the same scale.</li>
        </ul>
      </div>

      <div class="rules" style="margin-top:8px;">
        <b>How to enter a drink:</b>
        <ul>
          <li>Tap the button below to open the drink log form.</li>
          <li>Select: <b>Player Name</b> ‚Üí <b>Segment</b> ‚Üí <b>Drink Type</b>.</li>
          <li>Press <b>Submit</b>. Done.</li>
        </ul>
      </div>

      <div class="panelActions">
        <a class="btn primary btnLink"
           href="https://docs.google.com/forms/d/e/1FAIpQLSdFrjugo2wxI_GVKMW2xTJUvlhv9qDhgePPYaZHWDi5Vynuag/viewform?usp=header"
           target="_blank" rel="noopener">
          üç∫ LOG A DRINK
        </a>

        <a class="btn btnLink"
           href="https://docs.google.com/forms/d/e/1FAIpQLSdFrjugo2wxI_GVKMW2xTJUvlhv9qDhgePPYaZHWDi5Vynuag/viewform?usp=header"
           target="_blank" rel="noopener">
          Open Form (Backup)
        </a>
      </div>

      <div class="hint">
        If you‚Äôre in the app and the form opens in a browser tab, that‚Äôs normal. Fill it in, submit, then come back and refresh the leaderboard.
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="pill" id="status">Loading‚Ä¶</div>
    <div style="display:flex; gap:10px;">
      <button class="btn" id="refresh">Refresh</button>
      <button class="btn primary" id="auto">Auto: ON</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Overall</h2>
      <div id="overallArea" class="muted">Loading‚Ä¶</div>
    </div>

    <div class="card">
      <h2>By Segment</h2>
      <div id="segmentArea" class="muted">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<script>
/* =========================
   Collapsible panel logic
   ========================= */
const toggleBtn = document.getElementById("toggleLog");
const panelBody = document.getElementById("panelBody");
const toggleText = document.getElementById("toggleText");
const toggleChev = document.getElementById("toggleChev");

toggleBtn.addEventListener("click", () => {
  const isOpen = panelBody.classList.toggle("open");
  toggleChev.classList.toggle("open", isOpen);
  toggleText.textContent = isOpen ? "Close" : "Open";

  if (isOpen){
    document.getElementById("logPanel").scrollIntoView({ behavior:"smooth", block:"start" });
  }
});

/* =========================
   Leaderboard code
   ========================= */
const AUTO_INTERVAL_MS = 60000;
const RETRY_ON_429_MS  = 90000;

const RAW_OVERALL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz7JrkXY0j6sJHy1uwtLJJvI8WbVoYelnOgUyW4f0xWTzkhl6XaH-77MQIXnGnIlSRsBcxoCzkLsBc/pub?gid=755088792&single=true&output=csv";
const RAW_SEGMENT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz7JrkXY0j6sJHy1uwtLJJvI8WbVoYelnOgUyW4f0xWTzkhl6XaH-77MQIXnGnIlSRsBcxoCzkLsBc/pub?gid=74730700&single=true&output=csv";

function proxify(url){
  return "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, "");
}
const OVERALL_CSV = proxify(RAW_OVERALL_CSV);
const SEGMENT_CSV = proxify(RAW_SEGMENT_CSV);

const FULL_SQUAD = ["Alex","Ben","Brad","Craig","Jack","Sam"];
const CORE_SQUAD = ["Ben","Brad","Craig"];

let autoOn = true;
let timer = null;

const statusEl = document.getElementById("status");
const overallArea = document.getElementById("overallArea");
const segmentArea = document.getElementById("segmentArea");
const refreshBtn = document.getElementById("refresh");
const autoBtn = document.getElementById("auto");

refreshBtn.onclick = () => loadAll(true);
autoBtn.onclick = () => {
  autoOn = !autoOn;
  autoBtn.textContent = "Auto: " + (autoOn ? "ON" : "OFF");
  autoBtn.classList.toggle("primary", autoOn);
  if (autoOn) startAuto(); else stopAuto();
};

function startAuto(){ stopAuto(); timer = setInterval(() => loadAll(false), AUTO_INTERVAL_MS); }
function stopAuto(){ if (timer) clearInterval(timer); timer = null; }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function parseCSV(text){
  const rows = [];
  let cur = "", inQuotes = false;
  let row = [];
  for (let i=0; i<text.length; i++){
    const c = text[i], next = text[i+1];
    if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
    if (c === '"'){ inQuotes = !inQuotes; continue; }
    if (c === ',' && !inQuotes){ row.push(cur); cur=""; continue; }
    if ((c === '\n' || c === '\r') && !inQuotes){
      if (cur.length || row.length){ row.push(cur); cur=""; rows.push(row); row=[]; }
      continue;
    }
    cur += c;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.map(r => r.map(v => v.trim()));
}

async function fetchText(url, label, allowRetry=true){
  const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
  const res = await fetch(url + bust, { cache:"no-store" });

  if (res.status === 429){
    if (!allowRetry) throw new Error(label + " fetch failed: 429");
    statusEl.textContent = "Rate limited (429). Cooling down‚Ä¶";
    autoOn = false;
    autoBtn.textContent = "Auto: OFF";
    autoBtn.classList.remove("primary");
    await sleep(RETRY_ON_429_MS);
    return fetchText(url, label, false);
  }
  if (!res.ok) throw new Error(label + " fetch failed: " + res.status);
  return await res.text();
}

function extractCSVFromProxy(text, requiredHeaderWords){
  const lines = String(text).split(/\r?\n/);
  for (let i = 0; i < lines.length; i++){
    const line = lines[i].trim();
    const lower = line.toLowerCase();
    const looksCSV = line.includes(",") && line.length > 3;
    const hasRequired = requiredHeaderWords.every(w => lower.includes(w));
    if (looksCSV && hasRequired) return lines.slice(i).join("\n");
  }
  const firstComma = lines.findIndex(l => l.includes(","));
  return firstComma >= 0 ? lines.slice(firstComma).join("\n") : String(text);
}

function toNumber(x){
  const n = Number(String(x).replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : 0;
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

function renderOverall(rows){
  const header = (rows[0] || []).map(h => (h || "").toLowerCase());
  const playerIdx = header.findIndex(h => h.includes("player"));
  const ptsIdx = header.findIndex(h => h.includes("total") || h.includes("points"));

  if (playerIdx === -1 || ptsIdx === -1){
    overallArea.innerHTML = `<div class="error">Overall CSV headers not found.</div>`;
    return;
  }

  const data = rows.slice(1)
    .filter(r => (r[playerIdx] || "").trim().length)
    .map(r => ({ player: r[playerIdx], pts: toNumber(r[ptsIdx]) }))
    .sort((a,b) => b.pts - a.pts);

  if (!data.length){
    overallArea.innerHTML = `<div class="muted">No entries yet.</div>`;
    return;
  }

  let html = `<table>
    <thead><tr><th class="rank">#</th><th>Player</th><th class="pts">Points</th></tr></thead><tbody>`;

  data.forEach((d, i) => {
    html += `<tr class="${i===0 ? "topRow" : ""}">
      <td class="rank">${i+1}</td>
      <td><b>${escapeHtml(d.player)}</b></td>
      <td class="pts">${d.pts}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  overallArea.innerHTML = html;
}

function renderSegmentTables(rows){
  const headers = rows[0] || [];
  if (rows.length < 2 || headers.length < 2){
    segmentArea.innerHTML = `<div class="muted">No segment data yet.</div>`;
    return;
  }

  const headerLower = headers.map(h => (h || "").toLowerCase());
  let playerIdx = headerLower.findIndex(h => h.includes("player"));
  if (playerIdx === -1) playerIdx = 0;

  const segmentCols = headers
    .map((h, i) => ({ h, i }))
    .filter(c =>
      c.i !== playerIdx &&
      !String(c.h).toLowerCase().includes("grand") &&
      String(c.h).trim().length
    );

  const rowByPlayer = new Map();
  rows.slice(1)
    .filter(r => (String(r[playerIdx] || "")).toLowerCase() !== "grand total")
    .forEach(r => rowByPlayer.set(String(r[playerIdx] || "").trim(), r));

  let html = "";

  segmentCols.forEach(seg => {
    const segTitle = String(seg.h || "");
    const allowedPlayers = segTitle.includes("Before 17:00") ? FULL_SQUAD : CORE_SQUAD;

    const data = allowedPlayers.map(name => {
      const r = rowByPlayer.get(name);
      const pts = r ? toNumber(r[seg.i]) : 0;
      return { player: name, pts };
    }).sort((a,b) => b.pts - a.pts);

    html += `<div class="card" style="margin-bottom:12px">
      <h2>${escapeHtml(segTitle)}</h2>
      <table>
        <thead><tr><th class="rank">#</th><th>Player</th><th class="pts">Points</th></tr></thead>
        <tbody>`;

    data.forEach((d,i) => {
      html += `<tr class="${i===0 ? "topRow" : ""}">
        <td class="rank">${i+1}</td>
        <td><b>${escapeHtml(d.player)}</b></td>
        <td class="pts">${d.pts}</td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
  });

  segmentArea.innerHTML = html || `<div class="muted">No segment data yet.</div>`;
}

async function loadAll(showStatus){
  try{
    if (showStatus) statusEl.textContent = "Updating‚Ä¶";

    const [overallRaw, segmentRaw] = await Promise.all([
      fetchText(OVERALL_CSV, "Overall"),
      fetchText(SEGMENT_CSV, "By Segment")
    ]);

    const overallCSV = extractCSVFromProxy(overallRaw, ["player", "total"]);
    const segmentCSV = extractCSVFromProxy(segmentRaw, ["player"]);

    renderOverall(parseCSV(overallCSV));
    renderSegmentTables(parseCSV(segmentCSV));

    statusEl.textContent = "Last update: " + new Date().toLocaleTimeString();
  } catch (e){
    statusEl.textContent = "Error loading tables";
    overallArea.innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
    segmentArea.innerHTML = `<div class="muted">Check Publish-to-web is enabled for both sheets.</div>`;
  }
}

loadAll(true);
startAuto();
</script>
</body>
</html>
